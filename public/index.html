<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Dubix HTTPS Wakeword</title>
<style>
body { font-family:sans-serif; text-align:center; margin:1rem; }
#log { background:#111; color:#0f0; padding:1em; height:200px; overflow:auto; white-space:pre-wrap; }
button { margin:0.5em; padding:10px 15px; }
</style>
</head>
<body>
<h2>ðŸŽ™ Dubix HTTPS Wakeword</h2>
<button id="startBtn">Start Stream</button>
<button id="stopBtn">Stop</button>
<div id="log"></div>

<script>
const SERVER = location.origin;
let audioCtx, workletNode, pollInterval;

function log(m){ const el=document.getElementById("log"); el.textContent += m+"\n"; el.scrollTop=el.scrollHeight; }

document.getElementById("startBtn").onclick = async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
    audioCtx = new AudioContext({ sampleRate:16000 });
    await audioCtx.resume();
    await audioCtx.audioWorklet.addModule('/pcm-worklet.js');

    const source = audioCtx.createMediaStreamSource(stream);
    workletNode = new AudioWorkletNode(audioCtx, 'pcm-worklet');
    workletNode.port.onmessage = e => {
      fetch(`${SERVER}/stream`, { method:"POST", body:e.data });
    };
    source.connect(workletNode);

    log("ðŸŽ¤ Streaming started...");
    pollInterval = setInterval(async ()=>{
      const res = await fetch(`${SERVER}/poll`);
      if(res.ok){
        const data = await res.json();
        if(data.length) log("ðŸ” Server: " + JSON.stringify(data));
      }
    }, 800);
  } catch(err){
    log("âš ï¸ Error: " + err.message);
  }
};

document.getElementById("stopBtn").onclick = ()=>{
  clearInterval(pollInterval);
  if(audioCtx) audioCtx.close();
  log("ðŸ›‘ Stopped.");
};
</script>
</body>
</html>

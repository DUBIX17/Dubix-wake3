<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Dubix Wake Word Stream</title>
<style>
body { font-family:sans-serif; text-align:center; margin:1rem; }
#log { background:#111; color:#0f0; white-space:pre-wrap; padding:1em; height:200px; overflow:auto; }
</style>
</head>
<body>
<h2>ðŸŽ¤ Dubix HTTPS Wake Word Site</h2>
<button id="startBtn">Start Stream</button>
<button id="stopBtn">Stop</button>
<div id="log"></div>

<script>
const SERVER = location.origin; // or "https://yourapp.onrender.com"
let audioCtx, workletNode, pollInterval;

function log(m){ 
  const el=document.getElementById("log");
  el.textContent += m + "\n"; 
  el.scrollTop = el.scrollHeight;
}

document.getElementById("startBtn").onclick = async () => {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  audioCtx = new AudioContext({ sampleRate: 16000 });
  await audioCtx.audioWorklet.addModule(URL.createObjectURL(new Blob([`
    class PCMWorklet extends AudioWorkletProcessor {
      constructor() {
        super();
        this.buffer = [];
        this.samples = 0;
      }
      process(inputs) {
        const input = inputs[0][0];
        if (!input) return true;
        this.buffer.push(...input);
        this.samples += input.length;
        if (this.samples >= 3200) { // 200ms @16kHz
          const pcm16 = new Int16Array(this.buffer.length);
          for (let i=0;i<this.buffer.length;i++) pcm16[i] = this.buffer[i]*0x7fff;
          this.port.postMessage(pcm16.buffer, [pcm16.buffer]);
          this.buffer = [];
          this.samples = 0;
        }
        return true;
      }
    }
    registerProcessor('pcm-worklet', PCMWorklet);
  `], {type:'application/javascript'})));

  const source = audioCtx.createMediaStreamSource(stream);
  workletNode = new AudioWorkletNode(audioCtx, 'pcm-worklet');
  workletNode.port.onmessage = e => {
    fetch(\`\${SERVER}/stream\`, { method: "POST", body: e.data });
  };
  source.connect(workletNode);

  log("ðŸŽ™ Streaming started");

  pollInterval = setInterval(async ()=>{
    const res = await fetch(\`\${SERVER}/poll\`);
    if(res.ok){
      const data = await res.json();
      if(data.length) log("ðŸ” Server: "+JSON.stringify(data));
    }
  }, 800);
};

document.getElementById("stopBtn").onclick = ()=>{
  clearInterval(pollInterval);
  if(audioCtx) audioCtx.close();
  log("ðŸ›‘ Stopped.");
};
</script>
</body>
</html>

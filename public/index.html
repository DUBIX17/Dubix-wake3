<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Alex Wake Word + Deepgram STT</title>
</head>
<body>
  <h1>Alex Wake Word + STT Test</h1>
  <button id="startBtn">Start Microphone</button>
  <p id="status">Status: Idle</p>
  <pre id="transcript"></pre>

  <script>
    const ws = new WebSocket('ws://' + location.hostname + ':8765');

    ws.onopen = () => {
      document.getElementById('status').innerText = 'Status: Connected';
    };

    ws.onmessage = (msg) => {
      try {
        const data = JSON.parse(msg.data);
        if (data.transcript) {
          document.getElementById('transcript').innerText = 'Transcript: ' + data.transcript;
        }
      } catch {
        // wake word detection
        if (msg.data === 'Alex detected') {
          document.getElementById('status').innerText = 'Status: Alex detected, recording...';
        }
      }
    };

    const startBtn = document.getElementById('startBtn');

    startBtn.onclick = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const audioCtx = new AudioContext({ sampleRate: 16000 });
      const source = audioCtx.createMediaStreamSource(stream);
      const processor = audioCtx.createScriptProcessor(1024, 1, 1);

      source.connect(processor);
      processor.connect(audioCtx.destination);

      processor.onaudioprocess = (e) => {
        const input = e.inputBuffer.getChannelData(0);
        ws.send(Float32Array.from(input).buffer);
      };
    };
  </script>
</body>
</html>
